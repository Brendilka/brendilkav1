<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Brendilka Time Manager</title>

    <!-- Fonts and Icons from Manager Dashboard -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Global and Header Styles from Manager Dashboard */
        *, *::before, *::after { 
            box-sizing: border-box; 
        }
        body { 
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0; /* Changed from padding: 20px */
            background-color: #f4f7f6; 
            color: #333; 
            line-height: 1.6; 
        }
        .page-header { 
            background-color: #2c3e50; 
            color: #ecf0f1; 
            padding: 20px; 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 5px solid #1abc9c; 
            width: 100%; 
        }
        .page-header h1 { 
            margin: 0; 
            font-size: 2.2em; 
            font-weight: 400; 
            letter-spacing: 1px; 
            line-height: 1.3; 
        }

        /* Original Admin Panel Styles */
        .admin-container {
            max-width: 1600px;
            margin: auto;
            padding: 0 20px 20px 20px; /* Added padding here */
        }

        .layout-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
            align-items: flex-start;
        }

        .card {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.07);
            width: 100%;
        }

        .card h2 {
            margin-top: 0;
            color: #2c3e50;
            text-align: center;
        }

        .form-group { margin-bottom: 15px; }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .full-width { grid-column: 1 / -1; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #34495e;
        }
        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
        }
        .btn {
            display: inline-block;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        .btn-create { background-color: #1abc9c; }
        .btn-create:hover { background-color: #16a085; }
        .btn-delete {
            background-color: #e74c3c;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        .btn-delete:hover { background-color: #c0392b; }

        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }
        th { background-color: #f2f2f2; }
        td a {
            font-weight: 500;
            color: #2980b9;
            text-decoration: none;
        }
        td a:hover {
            text-decoration: underline;
        }

        .role-fields {
            padding-top: 15px;
            border-top: 2px solid #f4f7f6;
            margin-top: 15px;
        }

        @media (min-width: 1024px) {
            .layout-grid {
                flex-direction: row;
            }
            .form-container {
                flex: 1 1 450px;
            }
            .table-container {
                flex: 2 1 600px;
            }
        }
    </style>
</head>
<body>
    <header class="page-header">
        <h1>Brendilka Time Manager - Admin</h1>
    </header>

    <div class="admin-container">
        <div class="layout-grid">
            <!-- Section 1: Create User Form -->
            <div class="form-container card">
                <h2>Create New User</h2>
                <form action="/register" method="POST">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="role">Role</label>
                            <select id="role" name="role" required onchange="toggleRoleFields()">
                                <option value="employee">Employee</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="username">Username / Login ID</label><input type="text" id="username" name="username" required></div>
                        <div class="form-group"><label for="password">Password</label><input type="password" id="password" name="password" required></div>
                        <div class="form-group"><label for="full_name">Full Name</label><input type="text" id="full_name" name="full_name" required></div>
                        <div class="form-group"><label for="employee_id">Employee ID</label><input type="text" id="employee_id" name="employee_id" required></div>

                        <!-- *** UPDATED: MOVED FROM MANAGER-ONLY SECTION TO HERE *** -->
                        <div class="form-group"><label for="home_address">Home Address</label><input type="text" id="home_address" name="home_address"></div>
                        <div class="form-group"><label for="phone_number">Personal Phone</label><input type="text" id="phone_number" name="phone_number"></div>

                        <div class="form-group"><label for="job_title">Job Title</label><input type="text" id="job_title" name="job_title"></div>
                        <div class="form-group"><label for="department">Department</label><input type="text" id="department" name="department"></div>
                        <div class="form-group"><label for="emergency_contact_name">Emergency Contact Name</label><input type="text" id="emergency_contact_name" name="emergency_contact_name"></div>
                        <div class="form-group"><label for="emergency_contact_phone">Emergency Contact Phone</label><input type="text" id="emergency_contact_phone" name="emergency_contact_phone"></div>
                    </div>
                    <div id="employee-fields" class="role-fields form-grid">
                        <div class="form-group full-width"><label for="manager_name">Manager's Name</label><input type="text" id="manager_name" name="manager_name"></div>
                    </div>
                    <div id="manager-fields" class="role-fields form-grid" style="display: none;">
                        <!-- *** Home Address and Phone Number REMOVED from here *** -->
                        <div class="form-group"><label for="personal_email">Personal Email</label><input type="email" id="personal_email" name="personal_email"></div>
                        <div class="form-group"><label for="site_location">Site / Location</label><input type="text" id="site_location" name="site_location"></div>
                        <div class="form-group"><label for="job_grade">Job Grade</label><input type="text" id="job_grade" name="job_grade"></div>
                        <div class="form-group full-width"><label for="business_email">Business Email</label><input type="email" id="business_email" name="business_email"></div>
                    </div>
                    <button type="submit" class="btn btn-create">Create User</button>
                </form>
            </div>

            <!-- Section 2: Registered Users Table -->
            <div class="table-container card">
                <h2>Registered Users</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Role</th>
                            <th>Job Title</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="user-table">
                        <!-- User data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function toggleRoleFields() {
            const role = document.getElementById('role').value;
            // *** UPDATED: REMOVED THE TWO LINES THAT DISABLED THE INPUTS ***
            document.getElementById('manager_name').disabled = (role !== 'employee');
            document.getElementById('personal_email').disabled = (role !== 'manager');
            document.getElementById('site_location').disabled = (role !== 'manager');
            document.getElementById('job_grade').disabled = (role !== 'manager');
            document.getElementById('business_email').disabled = (role !== 'manager');

            document.getElementById('employee-fields').style.display = role === 'employee' ? 'grid' : 'none';
            document.getElementById('manager-fields').style.display = role === 'manager' ? 'grid' : 'none';
        }

        function deleteUser(userId, buttonElement) {
            if (confirm(`Are you sure you want to delete user with ID ${userId}? This cannot be undone.`)) {
                fetch(`/delete-user/${userId}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        buttonElement.closest('tr').remove();
                    } else {
                        alert(`Error: ${data.message}`);
                    }
                })
                .catch(err => console.error('Delete fetch error:', err));
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            toggleRoleFields();
            // *** UPDATED to use the new public endpoint and handle errors ***
            fetch('/api/admin/users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(users => {
                    const tableBody = document.getElementById('user-table');
                    tableBody.innerHTML = '';
                    if (users && Array.isArray(users)) {
                        users.forEach(user => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td><a href="/edit-user.html?id=${user.id}">${user.full_name || 'N/A'}</a></td>
                                <td>${user.role}</td>
                                <td>${user.job_title || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-delete" onclick="deleteUser(${user.id}, this)">Delete</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching users:', error)
                    const tableBody = document.getElementById('user-table');
                    tableBody.innerHTML = `<tr><td colspan="6">Error loading user data. See console for details.</td></tr>`;
                });
        });
    </script>
</body>
</html>